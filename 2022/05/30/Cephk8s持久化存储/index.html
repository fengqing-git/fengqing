<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Ceph-k8s持久化存储 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Ceph-k8s持久化存储环境配置   节点 主机IP 系统 磁盘 配置 版本    k8s-master01 192.168.3.93 centos8s-mini 测试:16G 生产环境请酌情 2C4G 1.23.6（最新）   k8s-master02 192.168.3.91 centos8s-mini 测试:16G 生产环境请酌情 2C4G 1.23.6（最新）   k8s-node01">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceph-k8s持久化存储">
<meta property="og:url" content="http://example.com/2022/05/30/Cephk8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Ceph-k8s持久化存储环境配置   节点 主机IP 系统 磁盘 配置 版本    k8s-master01 192.168.3.93 centos8s-mini 测试:16G 生产环境请酌情 2C4G 1.23.6（最新）   k8s-master02 192.168.3.91 centos8s-mini 测试:16G 生产环境请酌情 2C4G 1.23.6（最新）   k8s-node01">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images%5Cimage-20220516104139144.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220516105049073.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220516112234498.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220527233941382.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220527234231698.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220527234533816.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220527234717606.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220527235920450.png">
<meta property="og:image" content="http://example.com/images%5Cimage-20220528000445436.png">
<meta property="article:published_time" content="2022-05-29T16:15:10.000Z">
<meta property="article:modified_time" content="2022-05-30T01:07:20.670Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images%5Cimage-20220516104139144.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="Ceph-Cephk8s持久化存储" class="h-entry article article-type-Ceph" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/30/Cephk8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/" class="article-date">
  <time class="dt-published" datetime="2022-05-29T16:15:10.000Z" itemprop="datePublished">2022-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Ceph-k8s持久化存储
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Ceph-k8s持久化存储"><a href="#Ceph-k8s持久化存储" class="headerlink" title="Ceph-k8s持久化存储"></a>Ceph-k8s持久化存储</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><table>
<thead>
<tr>
<th>节点</th>
<th align="left">主机IP</th>
<th align="left">系统</th>
<th>磁盘</th>
<th>配置</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master01</td>
<td align="left">192.168.3.93</td>
<td align="left">centos8s-mini</td>
<td>测试:16G 生产环境请酌情</td>
<td>2C4G</td>
<td>1.23.6（最新）</td>
</tr>
<tr>
<td>k8s-master02</td>
<td align="left">192.168.3.91</td>
<td align="left">centos8s-mini</td>
<td>测试:16G 生产环境请酌情</td>
<td>2C4G</td>
<td>1.23.6（最新）</td>
</tr>
<tr>
<td>k8s-node01</td>
<td align="left">192.168.3.92</td>
<td align="left">centos8s-mini</td>
<td>测试:16G 生产环境请酌情</td>
<td>2C4G</td>
<td>1.23.6（最新）</td>
</tr>
<tr>
<td>k8s-node02</td>
<td align="left">192.168.3.95</td>
<td align="left">centos8s-mini</td>
<td>测试:16G 生产环境请酌情</td>
<td>2C4G</td>
<td>1.23.6（最新）</td>
</tr>
<tr>
<td>ceph01</td>
<td align="left">192.168.3.125</td>
<td align="left">centos7.9-mini</td>
<td>测试:16+50G 生产环境请酌情</td>
<td>1C2G</td>
<td>14.2.22</td>
</tr>
<tr>
<td>ceph02</td>
<td align="left">192.168.3.126</td>
<td align="left">centos7.9-mini</td>
<td>测试:16+50G 生产环境请酌情</td>
<td>1C2G</td>
<td>14.2.22</td>
</tr>
<tr>
<td>ceph03</td>
<td align="left">192.168.3.127</td>
<td align="left">centos7.9-mini</td>
<td>测试:16+50G 生产环境请酌情</td>
<td>1C2G</td>
<td>14.2.22</td>
</tr>
</tbody></table>
<h2 id="静态PV-amp-PVC"><a href="#静态PV-amp-PVC" class="headerlink" title="静态PV&amp;PVC"></a>静态PV&amp;PVC</h2><h3 id="ceph节点配置"><a href="#ceph节点配置" class="headerlink" title="ceph节点配置"></a>ceph节点配置</h3><h4 id="创建存储池"><a href="#创建存储池" class="headerlink" title="创建存储池"></a>创建存储池</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create kube 128 128</span><br></pre></td></tr></table></figure>

<h4 id="创建ceph账号和key"><a href="#创建ceph账号和key" class="headerlink" title="创建ceph账号和key"></a>创建ceph账号和key</h4><ul>
<li>创建账号</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.kube mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow class-read object_prefix rbd_children,allow rwx pool=kube&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看账号</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph auth list</span><br><span class="line"><span class="comment">#查看所有账号</span></span><br></pre></td></tr></table></figure>

<ul>
<li>base64单向加密一下，k8s不以明文方式存储账号密码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-key client.kube | <span class="built_in">base64</span> <span class="comment">#获得admin的key base64 单向加密</span></span><br><span class="line">ceph auth get-key client.admin | <span class="built_in">base64</span> <span class="comment">#获得kube的key base64 单向加密</span></span><br></pre></td></tr></table></figure>

<p><img src="/../images%5Cimage-20220516104139144.png" alt="image-20220516104139144"></p>
<h4 id="创建-kube下的image"><a href="#创建-kube下的image" class="headerlink" title="创建 kube下的image"></a>创建 kube下的image</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd create -p kube -s 5G ceph-image</span><br></pre></td></tr></table></figure>

<h3 id="k8s节点配置yaml"><a href="#k8s节点配置yaml" class="headerlink" title="k8s节点配置yaml"></a>k8s节点配置yaml</h3><h4 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建namespace</h4><ul>
<li>为了环境隔离，所有的都在cephfs空间完成</li>
<li>namespaces.yaml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; namespaces.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">#namespace固定写法</span></span><br><span class="line"><span class="string">kind: Namespace</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: cephfs</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ceph-admin-secret.yaml</li>
</ul>
<h4 id="创建admin-secret"><a href="#创建admin-secret" class="headerlink" title="创建admin-secret"></a>创建admin-secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; ceph-admin-secret.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Secret</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-admin-secret</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  key:  #( admin 的key)</span></span><br><span class="line"><span class="string">type:</span></span><br><span class="line"><span class="string">  kubernetes.io/rbd</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ceph-kube-secret.yaml</li>
</ul>
<h4 id="创建kube-secret"><a href="#创建kube-secret" class="headerlink" title="创建kube-secret"></a>创建kube-secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; ceph-kube-secret.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Secret</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-kube-secret</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  key:  #( kube 的key)</span></span><br><span class="line"><span class="string">type:</span></span><br><span class="line"><span class="string">  kubernetes.io/rbd</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改ceph-admin-secret.yaml和ceph-kube-secret.yaml，把对应key输入进去</li>
</ul>
<p><img src="/../images%5Cimage-20220516105049073.png" alt="image-20220516105049073"></p>
<h4 id="创建测试用PV"><a href="#创建测试用PV" class="headerlink" title="创建测试用PV"></a>创建测试用PV</h4><ul>
<li>pv.yaml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pv.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolume</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-pv-test</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 2Gi</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  rbd:</span></span><br><span class="line"><span class="string">    monitors:</span></span><br><span class="line"><span class="string">      - 192.168.3.125:6789</span></span><br><span class="line"><span class="string">      - 192.168.3.126:6789</span></span><br><span class="line"><span class="string">      - 192.168.3.127:6789</span></span><br><span class="line"><span class="string">    pool: kube</span></span><br><span class="line"><span class="string">    image: ceph-image</span></span><br><span class="line"><span class="string">    user: admin</span></span><br><span class="line"><span class="string">    secretRef:</span></span><br><span class="line"><span class="string">      name: ceph-admin-secret</span></span><br><span class="line"><span class="string">    fsType: ext4</span></span><br><span class="line"><span class="string">    readOnly: false</span></span><br><span class="line"><span class="string">  persistentVolumeReclaimPolicy: Retain</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建测试用PVC"><a href="#创建测试用PVC" class="headerlink" title="创建测试用PVC"></a>创建测试用PVC</h4><ul>
<li>pvc.yaml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pvc.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-test-claim</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 2Gi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建测试用pod"><a href="#创建测试用pod" class="headerlink" title="创建测试用pod"></a>创建测试用pod</h4><ul>
<li>pod.yaml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; pod.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-pod</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: test-pod</span></span><br><span class="line"><span class="string">    image: busybox:1.24</span></span><br><span class="line"><span class="string">    command: [&quot;sleep&quot;, &quot;60000&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: pvc</span></span><br><span class="line"><span class="string">      mountPath: /usr/share/busybox</span></span><br><span class="line"><span class="string">      readOnly: false</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: pvc</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: ceph-test-claim</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h4><ul>
<li>&#96;&#96;&#96;bash<br>[root@k8s-master01 pv-pvc]# ls<br>ceph-admin-secret.yaml  ceph-kube-secret.yaml  namespaces.yaml  pod.yaml  pvc.yaml  pv.yaml<br>[root@k8s-master01 pv-pvc]# kubectl apply -f namespaces.yaml<br>namespace&#x2F;cephfs created<br>[root@k8s-master01 pv-pvc]# kubectl apply -f ceph-admin-secret.yaml<br>secret&#x2F;ceph-admin-secret created<br>[root@k8s-master01 pv-pvc]# kubectl apply -f ceph-kube-secret.yaml<br>secret&#x2F;ceph-kube-secret created<br>[root@k8s-master01 pv-pvc]# kubectl apply -f pv.yaml<br>persistentvolume&#x2F;ceph-pv-test configured<br>[root@k8s-master01 pv-pvc]# kubectl apply -f pvc.yaml<br>persistentvolumeclaim&#x2F;ceph-test-claim created<br>[root@k8s-master01 pv-pvc]# kubectl apply -f pod.yaml<br>pod&#x2F;ceph-pod created<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 查看状态</span><br><span class="line"></span><br><span class="line">- ```bash</span><br><span class="line">  kubectl get pv -n cephfs</span><br><span class="line">  kubectl get pvc -n cephfs</span><br><span class="line">  kubectl get pod -n cephfs</span><br></pre></td></tr></table></figure>

<img src="/../images%5Cimage-20220516112234498.png" alt="image-20220516112234498"></li>
</ul>
<h2 id="动态storageClass"><a href="#动态storageClass" class="headerlink" title="动态storageClass"></a>动态storageClass</h2><h3 id="ceph节点配置-1"><a href="#ceph节点配置-1" class="headerlink" title="ceph节点配置"></a>ceph节点配置</h3><blockquote>
<p>cephfs方式支持k8s的pv的3种访问模式ReadWriteOnce，ReadOnlyMany ，ReadWriteMany</p>
</blockquote>
<h4 id="创建MDS"><a href="#创建MDS" class="headerlink" title="创建MDS"></a>创建MDS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf admin ceph-01 ceph-02 ceph-03 <span class="comment"># 传输admin密钥</span></span><br><span class="line">ceph-deploy mds create ceph-01 ceph-02 ceph-03 <span class="comment"># 三个节点做MDS</span></span><br><span class="line">ceph -s</span><br></pre></td></tr></table></figure>

<p><img src="/../images%5Cimage-20220527233941382.png" alt="image-20220527233941382"></p>
<h4 id="创建FileSystems"><a href="#创建FileSystems" class="headerlink" title="创建FileSystems"></a>创建FileSystems</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create cephfs-data 128 128 <span class="comment">#  创建数据</span></span><br><span class="line">ceph osd pool create cephfs-metadata 128 128 <span class="comment"># 创建元数据</span></span><br><span class="line">ceph osd pool <span class="built_in">ls</span> |grep cephfs<span class="comment">#查看cephfs列表 一个 ceph 文件系统需要至少两个RADOS存储池，一个用于数据，一个用于元数据。</span></span><br><span class="line">ceph osd lspools <span class="comment"># 查看pools</span></span><br><span class="line">ceph fs <span class="built_in">ls</span> <span class="comment"># 查看FileSystems</span></span><br><span class="line">ceph mds <span class="built_in">stat</span> <span class="comment"># 查看MDS</span></span><br><span class="line">ceph fs status cephfs <span class="comment"># 查看FileSystems状态</span></span><br></pre></td></tr></table></figure>

<p><img src="/../images%5Cimage-20220527234231698.png" alt="image-20220527234231698"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph fs new cephfs cephfs-metadata cephfs-data <span class="comment"># 创建FileSystems</span></span><br><span class="line">ceph fs <span class="built_in">ls</span> <span class="comment"># 查看fs列表</span></span><br><span class="line">ceph mds <span class="built_in">stat</span> <span class="comment"># 查看状态，#ceph-01为up状态</span></span><br></pre></td></tr></table></figure>

<p><img src="/../images%5Cimage-20220527234533816.png" alt="image-20220527234533816"></p>
<p><img src="/../images%5Cimage-20220527234717606.png" alt="image-20220527234717606"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clients 后面有的，一开始是没有的</span></span><br><span class="line">ceph auth get-key client.admin | <span class="built_in">base64</span> <span class="comment"># 密钥保存一下，后面要用</span></span><br></pre></td></tr></table></figure>

<h3 id="k8s节点配置"><a href="#k8s节点配置" class="headerlink" title="k8s节点配置"></a>k8s节点配置</h3><blockquote>
<p>1、创建命名空间</p>
<p>2、创建服务账户</p>
<p>3、创建角色</p>
<p>4、绑定角色</p>
<p>5、创建集群角色</p>
<p>6、绑定集群角色</p>
<p>7、部署 cephfs-provisioner</p>
<p>8、创建存储类</p>
<p>9、k8s集群要使用Ceph集群需要在每个Kubernetes节点上安装ceph-common # 不知道要不要，用静态的是一定要的，注意：安装ceph-common软件包推荐使用软件包源与Ceph集群源相同，软件版本一致。</p>
</blockquote>
<h4 id="创建ns"><a href="#创建ns" class="headerlink" title="创建ns"></a>创建ns</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns cephfs <span class="comment"># 创建ns</span></span><br></pre></td></tr></table></figure>

<h4 id="创建密钥"><a href="#创建密钥" class="headerlink" title="创建密钥"></a>创建密钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; ceph-secret.yaml &lt;&lt; <span class="string">EOF # 创建密钥</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Secret</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ceph-admin-secret</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">  key: &quot;QVFDalFZOWk5NnBpR3hBQUk2amxSQ3JGbHl5Uzc0eEsrdTd1b0E9PQ==&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="查看secret对比一下"><a href="#查看secret对比一下" class="headerlink" title="查看secret对比一下"></a>查看secret对比一下</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret ceph-admin-secret -n cephfs -o yaml <span class="comment"># 查看secret对比一下</span></span><br></pre></td></tr></table></figure>

<p><img src="/../images%5Cimage-20220527235920450.png" alt="image-20220527235920450"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; serviceaccount.yaml &lt;&lt; <span class="string">EOF # 创建服务账户</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建服务账户"><a href="#创建服务账户" class="headerlink" title="创建服务账户"></a>创建服务账户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; serviceaccount.yaml &lt;&lt; <span class="string">EOF # 创建服务账户</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建角色"><a href="#创建角色" class="headerlink" title="创建角色"></a>创建角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; role.yaml &lt;&lt; <span class="string">EOF # 创建角色</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Role</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;secrets&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;create&quot;, &quot;get&quot;, &quot;delete&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;endpoints&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="绑定角色"><a href="#绑定角色" class="headerlink" title="绑定角色"></a>绑定角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; rolebinding.yaml &lt;&lt; <span class="string">EOF #绑定角色</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: RoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: Role</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: ServiceAccount</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建集群角色"><a href="#创建集群角色" class="headerlink" title="创建集群角色"></a>创建集群角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; clusterrole.yaml &lt;&lt; <span class="string">EOF # 创建集群角色</span></span><br><span class="line"><span class="string">kind: ClusterRole</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;persistentvolumes&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;persistentvolumeclaims&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;storage.k8s.io&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;storageclasses&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;events&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;services&quot;]</span></span><br><span class="line"><span class="string">    resourceNames: [&quot;kube-dns&quot;,&quot;coredns&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;list&quot;, &quot;get&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;secrets&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;get&quot;, &quot;create&quot;, &quot;delete&quot;]</span></span><br><span class="line"><span class="string">  - apiGroups: [&quot;policy&quot;]</span></span><br><span class="line"><span class="string">    resourceNames: [&quot;cephfs-provisioner&quot;]</span></span><br><span class="line"><span class="string">    resources: [&quot;podsecuritypolicies&quot;]</span></span><br><span class="line"><span class="string">    verbs: [&quot;use&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="绑定集群角色"><a href="#绑定集群角色" class="headerlink" title="绑定集群角色"></a>绑定集群角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; clusterrolebinding.yaml &lt;&lt; <span class="string">EOF #绑定集群角色 </span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">  - kind: ServiceAccount</span></span><br><span class="line"><span class="string">    name: cephfs-provisioner</span></span><br><span class="line"><span class="string">    namespace: cephfs</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="部署-cephfs-provisioner"><a href="#部署-cephfs-provisioner" class="headerlink" title="部署 cephfs-provisioner"></a>部署 cephfs-provisioner</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; deployment.yaml &lt;&lt; <span class="string">EOF #部署 cephfs-provisioner</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs-provisioner</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 1</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: cephfs-provisioner</span></span><br><span class="line"><span class="string">  strategy:</span></span><br><span class="line"><span class="string">    type: Recreate</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: cephfs-provisioner</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: cephfs-provisioner</span></span><br><span class="line"><span class="string">        image: &quot;quay.io/external_storage/cephfs-provisioner:latest&quot; #镜像里面的ceph-common要和集群的一致</span></span><br><span class="line"><span class="string">        env:</span></span><br><span class="line"><span class="string">        - name: PROVISIONER_NAME</span></span><br><span class="line"><span class="string">          value: ceph.com/cephfs</span></span><br><span class="line"><span class="string">        - name: PROVISIONER_SECRET_NAMESPACE</span></span><br><span class="line"><span class="string">          value: cephfs</span></span><br><span class="line"><span class="string">        command:</span></span><br><span class="line"><span class="string">        - &quot;/usr/local/bin/cephfs-provisioner&quot;</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">        - &quot;-id=cephfs-provisioner-1&quot;</span></span><br><span class="line"><span class="string">        - &quot;-disable-ceph-namespace-isolation=true&quot; #添加</span></span><br><span class="line"><span class="string">      serviceAccount: cephfs-provisioner</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="创建存储类"><a href="#创建存储类" class="headerlink" title="创建存储类"></a>创建存储类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; class.yaml &lt;&lt; <span class="string">EOF #创建存储类 </span></span><br><span class="line"><span class="string">kind: StorageClass</span></span><br><span class="line"><span class="string">apiVersion: storage.k8s.io/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cephfs</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">provisioner: ceph.com/cephfs</span></span><br><span class="line"><span class="string">parameters:</span></span><br><span class="line"><span class="string">    monitors: 192.168.3.164:6789,192.168.3.167:6789,192.168.3.168:6789</span></span><br><span class="line"><span class="string">    adminId: admin</span></span><br><span class="line"><span class="string">    adminSecretName: ceph-admin-secret</span></span><br><span class="line"><span class="string">    adminSecretNamespace: &quot;cephfs&quot;</span></span><br><span class="line"><span class="string">    claimRoot: /pvc-volumes</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>1、如果你只有一个 mon 监控节点服务，“monitors” 这一项就填一个，末尾没有逗号，我这里有三个！！！</p>
<p>2、“claimRoot” 用来设定 PV 创建在 Ceph 文件系统中的目录</p>
</blockquote>
<ul>
<li>provisioner： 该字段指定使用存储卷类型为 kubernetes.io&#x2F;rbd，注意 kubernetes.io&#x2F; 开头为 k8s 内部支持的存储提供者，不同的存储卷提供者类型这里要修改成对应的值</li>
<li>monitors：  ceph监控节点</li>
<li>adminId：  这里需要指定两种 Ceph 角色 admin 和其他 user，admin 角色默认已经有了，其他 user 可以去 Ceph 集群创建一个并赋对应权限值，如果不创建，也可以都指定为 admin</li>
<li>adminSecretName：  为上边创建的 Ceph 管理员 admin 使用的 ceph-secret，名字与secret.yaml里面定义的名字保持一致</li>
<li>claimRoot：   在ceph上的目录结构</li>
</ul>
<h4 id="创建测试用PVC-1"><a href="#创建测试用PVC-1" class="headerlink" title="创建测试用PVC"></a>创建测试用PVC</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; claim.yaml &lt;&lt; <span class="string">EOF # 创建测试用PVC</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: claim1</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  storageClassName: cephfs</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteMany</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 1Gi</span></span><br><span class="line"><span class="string">EOF</span> </span><br></pre></td></tr></table></figure>

<h4 id="创建测试用POD"><a href="#创建测试用POD" class="headerlink" title="创建测试用POD"></a>创建测试用POD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; test-pod.yaml &lt;&lt; <span class="string">EOF # 创建测试用POD</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-pod</span></span><br><span class="line"><span class="string">  namespace: cephfs</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: test-pod</span></span><br><span class="line"><span class="string">    image: busybox:1.24</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - &quot;/bin/sh&quot;</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">      - &quot;-c&quot;</span></span><br><span class="line"><span class="string">      - &quot;touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">      - name: pvc</span></span><br><span class="line"><span class="string">        mountPath: &quot;/mnt&quot;</span></span><br><span class="line"><span class="string">  restartPolicy: &quot;Never&quot;</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: pvc</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: claim1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubectl apply -f serviceaccount.yaml</span><br><span class="line">kubectl apply -f role.yaml</span><br><span class="line">kubectl apply -f rolebinding.yaml</span><br><span class="line">kubectl apply -f clusterrole.yaml</span><br><span class="line">kubectl apply -f clusterrolebinding.yaml</span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line">kubectl apply -f class.yaml</span><br><span class="line">kubectl apply -f claim.yaml</span><br><span class="line">kubectl apply -f test-pod.yaml</span><br><span class="line">kubectl apply -f class.yaml</span><br><span class="line">kubectl get sc -n cephfs</span><br><span class="line">kubectl get sc cephfs -n cephfs -oyaml</span><br></pre></td></tr></table></figure>

<h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><p><img src="/../images%5Cimage-20220528000445436.png" alt="image-20220528000445436"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/30/Cephk8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/" data-id="cl3s198940000mrw30trc7bdn" data-title="Ceph-k8s持久化存储" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/05/30/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2022/05/30/fengqing/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">fengqing</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/30/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/05/30/Cephk8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/">Ceph-k8s持久化存储</a>
          </li>
        
          <li>
            <a href="/2022/05/30/fengqing/">fengqing</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>